{% extends 'core/base.html' %}
{% load user_status %}

{% block content %}
<div class="card">
  <div class="card-header bg-white">
    <div class="d-flex justify-content-between align-items-center">
      <div class="d-flex align-items-center">
        <strong class="me-2">Chat with:</strong>
        {% for p in conversation.participants.all %}
          {% if p != request.user %}
            <div class="position-relative">
              {% if p.photo %}
                <img src="{{ p.photo.url }}" alt="{{ p.username }}" class="rounded-circle me-2" style="width:40px;height:40px;object-fit:cover;">
              {% endif %}
              <span data-user-id="{{ p.id }}" class="position-absolute bottom-0 end-0 translate-middle p-1 border border-light rounded-circle {{ p|online_status }}" style="width:12px;height:12px;"></span>
            </div>
            <h5 class="mb-0">{{ p.username }}</h5>
           
          {% endif %}
        {% endfor %}
      </div>
      <a href="{% url 'conversations_list' %}" class="btn btn-outline-secondary btn-sm">All Conversations</a>
    </div>
  </div>
  
  <div class="card-body" style="max-height: 500px; overflow-y: auto;">
    <div id="typing-indicator" class="d-none mb-3">
      <div class="d-flex align-items-center">
        <div class="typing-avatar me-2">
          <i class="bi bi-person-circle" style="font-size:24px;color:#6c757d"></i>
        </div>
        <div class="typing-bubble bg-light rounded p-2">
          <div class="typing-dots">
            <span></span>
            <span></span>
            <span></span>
          </div>
        </div>
        <div class="typing-text small text-muted ms-2"></div>
      </div>
    </div>
    <div id="messages">
      {% for m in conversation_messages %}
        {% if m.sender == request.user %}
          <div class="d-flex mb-3 justify-content-end align-items-end" data-message-id="{{ m.id }}">
            <div class="message-bubble message-mine">
              <div class="message-content">{% if m.is_deleted %}<span class="text-muted fst-italic">Message deleted</span>{% else %}{{ m.content|linebreaksbr }}{% endif %}</div>
              {% if not m.is_deleted %}
                <div class="message-actions mt-1 text-end" style="opacity: 0.8">
                  <button class="btn btn-sm btn-link text-light reply-message" title="Reply" data-content="{{ m.content }}">
                    <i class="bi bi-reply"></i>
                  </button>
                  {% if m.sender == request.user %}
                    <button class="btn btn-sm btn-link text-light edit-message" title="Edit">
                      <i class="bi bi-pencil"></i>
                    </button>
                    <button class="btn btn-sm btn-link text-light delete-message" title="Delete">
                      <i class="bi bi-trash"></i>
                    </button>
                  {% endif %}
                </div>
              {% endif %}
              <small class="text-light d-block text-end">
                {{ m.timestamp|date:"g:i A" }} {% if m.edited_at %}<span class="fst-italic">(edited)</span>{% endif %}
              </small>
            </div>
            <div class="ms-2 position-relative">
              {% if m.sender.photo %}
                <img src="{{ m.sender.photo.url }}" alt="{{ m.sender.username }}" class="rounded-circle" style="width:36px;height:36px;object-fit:cover;">
              {% else %}
                <i class="bi bi-person-circle" style="font-size:36px;color:#6c757d"></i>
              {% endif %}
              <span data-user-id="{{ m.sender.id }}" class="position-absolute bottom-0 end-0 translate-middle p-1 border border-light rounded-circle {{ m.sender|online_status }}" style="width:10px;height:10px;"></span>
            </div>
          </div>
        {% else %}
          <div class="d-flex mb-3 align-items-start" data-message-id="{{ m.id }}">
            <div class="me-2">
              {% if m.sender.photo %}
                <img src="{{ m.sender.photo.url }}" alt="{{ m.sender.username }}" class="rounded-circle" style="width:36px;height:36px;object-fit:cover;">
              {% else %}
                <i class="bi bi-person-circle" style="font-size:36px;color:#6c757d"></i>
              {% endif %}
            </div>
            <div class="message-bubble message-other">
              <small class="text-muted d-block mb-1">{{ m.sender.username }}</small>
              <div class="message-content">{% if m.is_deleted %}<span class="text-muted fst-italic">Message deleted</span>{% else %}{{ m.content|linebreaksbr }}{% endif %}</div>
              {% if not m.is_deleted %}
                <div class="message-actions mt-1" style="opacity: 0.8">
                  <button class="btn btn-sm btn-link text-muted reply-message" title="Reply" data-content="{{ m.content }}">
                    <i class="bi bi-reply"></i>
                  </button>
                </div>
              {% endif %}
              <small class="text-muted d-block text-end">
                {{ m.timestamp|date:"g:i A" }} {% if m.edited_at %}<span class="fst-italic">(edited)</span>{% endif %}
              </small>
            </div>
          </div>
        {% endif %}
      {% empty %}
        <div class="text-center text-muted">
          <p>No messages yet ‚Äî say hi!</p>
        </div>
      {% endfor %}
    </div>
  </div>

  <div class="card-footer bg-white">
    <form method="post" id="message-form">
      {% csrf_token %}
      {% if form.non_field_errors %}
        <div class="alert alert-danger" id="form-errors">
          {{ form.non_field_errors }}
        </div>
      {% endif %}

      <div class="d-flex align-items-end gap-2">
        <div class="me-2">
          {% if request.user.photo %}
            <img src="{{ request.user.photo.url }}" alt="You" class="rounded-circle" style="width:38px;height:38px;object-fit:cover;">
          {% else %}
            <i class="bi bi-person-circle" style="font-size:38px;color:#6c757d"></i>
          {% endif %}
        </div>

        <div class="flex-grow-1 position-relative">
          {{ form.content }}
          <div class="d-flex mt-2 align-items-center">
            <button type="button" class="btn btn-sm btn-light me-2" id="emoji-btn" title="Emoji">
              <i class="bi bi-emoji-smile"></i>
            </button>
            <div id="emoji-panel" class="border rounded p-2 bg-white shadow position-absolute" 
                 style="display:none; width:320px; z-index:1000; bottom:100%; left:0;">
              <div class="d-flex mb-2 border-bottom pb-2">
                <button class="btn btn-sm btn-light me-1 emoji-category active" data-category="smileys">üòä</button>
                <button class="btn btn-sm btn-light me-1 emoji-category" data-category="gestures">üëã</button>
                <button class="btn btn-sm btn-light me-1 emoji-category" data-category="love">‚ù§Ô∏è</button>
                <button class="btn btn-sm btn-light me-1 emoji-category" data-category="nature">üå∫</button>
                <button class="btn btn-sm btn-light emoji-category" data-category="objects">üéà</button>
              </div>
              <div id="emoji-grid">
                <!-- emojis will be inserted here by JS -->
              </div>
            </div>
            <div class="small text-muted ms-2" id="attachment-preview" style="display:none;"></div>
            <div id="reply-preview" class="small text-muted ms-2" style="display:none;">
              <i class="bi bi-reply me-1"></i><span></span>
              <button type="button" class="btn btn-sm btn-link p-0 ms-2" id="cancel-reply">
                <i class="bi bi-x"></i>
              </button>
            </div>
          </div>
        </div>

        <div class="d-flex flex-column align-items-end">
          <input type="file" id="attach-file" style="display:none;">
          <button type="button" class="btn btn-outline-secondary btn-sm mb-2" id="attach-btn" title="Attach">
            <i class="bi bi-paperclip"></i>
          </button>
          <button type="submit" class="btn btn-primary" id="send-btn" title="Send">
            <i class="bi bi-send"></i>
          </button>
        </div>
      </div>

      {% if form.content.errors %}
        <div class="text-danger mt-2" id="content-errors">
          {{ form.content.errors }}
        </div>
      {% endif %}
    </form>
  </div>
</div>

<script>
(() => {
  const CONVERSATION_ID = "{{ conversation.id }}";
  // Organized emoji categories
  const emojiCategories = {
    smileys: ['üòÄ','üòÅ','üòÇ','ü§£','üòä','üòá','üôÇ','üôÉ','üòâ','üòå','üòç','ü•∞','üòò','üòó','üòô','üòö','üòã','üòõ','üòù','üòú','ü§™','ü§®','üßê','ü§ì','üòé','ü§©','ü•≥','üòè','üòí','üòû','üòî','üòü','üòï','üôÅ','‚òπÔ∏è','üò£','üòñ','üò´','üò©','ü•∫','üò¢','üò≠','üò§','üò†','üò°','ü§¨','ü§Ø','üò≥','ü•µ','ü•∂','üò±','üò®','üò∞','üò•','üòì','ü§ó','ü§î','ü§≠','ü§´','ü§•','üò∂','üòê','üòë','üò¨','üôÑ','üòØ','üò¶','üòß','üòÆ','üò≤','ü•±','üò¥','ü§§','üò™','üòµ','ü§ê','ü•¥','ü§¢','ü§Æ','ü§ß','üò∑','ü§í','ü§ï','ü§ë','ü§†'],
    gestures: ['üëã','ü§ö','‚úã','üñê','üëå','ü§å','ü§è','‚úåÔ∏è','ü§û','ü§ü','ü§ò','ü§ô','üëà','üëâ','üëÜ','üñï','üëá','‚òùÔ∏è','üëç','üëé','‚úä','üëä','ü§õ','ü§ú','üëè','üôå','üëê','ü§≤','ü§ù','üôè','‚úçÔ∏è','üí™','ü¶æ','ü¶ø','ü¶µ','ü¶∂','üëÇ','ü¶ª','üëÉ','ü´Ä','ü´Å','üß†','ü¶∑','ü¶¥','üëÄ','üëÅ','üëÖ','üëÑ','üíã','ü©∏'],
    love: ['‚ù§Ô∏è','üß°','üíõ','üíö','üíô','üíú','ü§é','üñ§','ü§ç','üíî','‚ù§Ô∏è‚Äçüî•','‚ù§Ô∏è‚Äçü©π','‚ù£Ô∏è','üíï','üíû','üíì','üíó','üíñ','üíò','üíù','üíü','‚ô•Ô∏è','üíå','üíã','üë©‚Äç‚ù§Ô∏è‚Äçüë®','üë®‚Äç‚ù§Ô∏è‚Äçüë®','üë©‚Äç‚ù§Ô∏è‚Äçüë©','üíë','üë©‚Äç‚ù§Ô∏è‚Äçüíã‚Äçüë®','üë®‚Äç‚ù§Ô∏è‚Äçüíã‚Äçüë®','üë©‚Äç‚ù§Ô∏è‚Äçüíã‚Äçüë©','üíè'],
    nature: ['üåµ','üéÑ','üå≤','üå≥','üå¥','üå±','üåø','‚òòÔ∏è','üçÄ','üéç','üéã','üçÉ','üçÇ','üçÅ','üçÑ','üêö','üåæ','üíê','üå∑','üåπ','ü•Ä','üå∫','üå∏','üåº','üåª','üåû','üåù','üåõ','üåú','üåö','üåï','üåñ','üåó','üåò','üåë','üåí','üåì','üåî','üåô','üåé','üåç','üåè','ü™ê','üí´','‚≠êÔ∏è','üåü','‚ú®','‚ö°Ô∏è','‚òÑÔ∏è','üí•','üî•','üå™','üåà','‚òÄÔ∏è','üå§','‚õÖÔ∏è','üå•','‚òÅÔ∏è','üå¶','üåß','‚õà','üå©','üå®','‚ùÑÔ∏è','‚òÉÔ∏è','‚õÑÔ∏è','üå¨','üí®','üíß','üí¶','‚òîÔ∏è','‚òÇÔ∏è','üåä','üå´'],
    objects: ['üéà','üéâ','üéä','üéÉ','üéÑ','üéã','üéç','üéé','üéè','üéê','üéë','üßß','üéÄ','üéÅ','üì©','üì®','üíå','üìÆ','üì™','üì´','üì¨','üì≠','üì¶','üìØ','üìú','üìÉ','üìÑ','üìë','üßæ','üìä','üìà','üìâ','üóí','üóì','üìÜ','üìÖ','üóë','üìá','üóÉ','üó≥','üóÑ','üìã','üìÅ','üìÇ','üóÇ','üóû','üì∞','üìì','üìî','üìí','üìï','üìó','üìò','üìô','üìö','üìñ','üîñ','üß∑','üîó','üìé','üñá','üìê','üìè','üßÆ','üìå','üìç','‚úÇÔ∏è','üñä','üñã','‚úíÔ∏è','üñå','üñç','üìù','‚úèÔ∏è','üîç','üîé','üîè','üîê','üîí','üîì']
  };

    let typingTimeout;
    const TYPING_TIMEOUT = 3000; // Stop showing typing indicator after 3 seconds of inactivity

    // Initialize everything when DOM is ready
    document.addEventListener('DOMContentLoaded', () => {
      // Cache DOM elements
      const elements = {
        typingIndicator: document.getElementById('typing-indicator'),
      form: document.getElementById('message-form'),
      messages: document.getElementById('messages'),
      formErrors: document.getElementById('form-errors'),
      contentErrors: document.getElementById('content-errors'),
      contentInput: document.querySelector('[name="content"]'),
      emojiBtn: document.getElementById('emoji-btn'),
      emojiPanel: document.getElementById('emoji-panel'),
      emojiGrid: document.getElementById('emoji-grid'),
      attachBtn: document.getElementById('attach-btn'),
      attachFile: document.getElementById('attach-file'),
      attachmentPreview: document.getElementById('attachment-preview'),
      replyPreview: document.getElementById('reply-preview'),
      cancelReply: document.getElementById('cancel-reply')
    };

    let replyingTo = null;
    let currentCategory = 'smileys';

    // Message editing handler
    const handleMessageEdit = (e) => {
      const editButton = e.target.closest('.edit-message');
      if (!editButton) return;

      const messageDiv = editButton.closest('[data-message-id]');
      const messageId = messageDiv.dataset.messageId;
      const contentDiv = messageDiv.querySelector('.message-content');
      const originalContent = contentDiv.textContent;

      const textarea = document.createElement('textarea');
      textarea.className = 'form-control';
      textarea.value = originalContent;
      contentDiv.replaceWith(textarea);
      textarea.focus();

      const saveEdit = () => {
        const newContent = textarea.value.trim();
        if (newContent && newContent !== originalContent) {
          fetch(`/messages/${messageId}/edit/`, {
            method: 'POST',
            headers: {
              'X-Requested-With': 'XMLHttpRequest',
              'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ content: newContent })
          })
          .then(response => response.json())
          .then(data => {
            if (data.status === 'ok') {
              const newDiv = document.createElement('div');
              newDiv.className = 'message-content';
              newDiv.textContent = data.message.content;
              textarea.replaceWith(newDiv);
              messageDiv.querySelector('small:last-child').innerHTML = 
                `${data.message.edited_at} <span class="fst-italic">(edited)</span>`;
            }
          });
        } else {
          const div = document.createElement('div');
          div.className = 'message-content';
          div.textContent = originalContent;
          textarea.replaceWith(div);
        }
      };

      const handleKeydown = (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          textarea.blur();
        } else if (e.key === 'Escape') {
          const div = document.createElement('div');
          div.className = 'message-content';
          div.textContent = originalContent;
          textarea.replaceWith(div);
        }
      };

      textarea.addEventListener('blur', saveEdit);
      textarea.addEventListener('keydown', handleKeydown);
    };

    // Message deletion handler
    const handleMessageDelete = (e) => {
      const deleteButton = e.target.closest('.delete-message');
      if (!deleteButton) return;

      if (!confirm('Are you sure you want to delete this message?')) return;

      const messageDiv = deleteButton.closest('[data-message-id]');
      const messageId = messageDiv.dataset.messageId;

      fetch(`/messages/${messageId}/delete/`, {
        method: 'POST',
        headers: {
          'X-Requested-With': 'XMLHttpRequest',
          'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.status === 'ok') {
          messageDiv.querySelector('.message-content').innerHTML = 
            '<div class="text-muted fst-italic">Message deleted</div>';
          messageDiv.querySelector('.message-actions').remove();
        }
      });
    };

    // Reply functionality
    const handleReplyClick = (e) => {
      const replyButton = e.target.closest('.reply-message');
      if (!replyButton) return;

      const messageDiv = replyButton.closest('[data-message-id]');
      const messageId = messageDiv.dataset.messageId;
      const content = replyButton.dataset.content;

      replyingTo = messageId;
      elements.replyPreview.style.display = 'inline-block';
      elements.replyPreview.querySelector('span').textContent = 
        content.substring(0, 50) + (content.length > 50 ? '...' : '');
      elements.contentInput.focus();
    };

    const handleCancelReply = () => {
      replyingTo = null;
      elements.replyPreview.style.display = 'none';
    };

    // Emoji picker functionality
    const showEmojiCategory = (category) => {
      currentCategory = category;
      const emojis = emojiCategories[category];
      
      elements.emojiGrid.innerHTML = '';
      const grid = document.createElement('div');
      grid.style.cssText = 'display:grid;grid-template-columns:repeat(8,1fr);gap:6px;max-height:200px;overflow-y:auto;';
      
      emojis.forEach(emoji => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'btn btn-sm btn-light';
        btn.style.padding = '6px';
        btn.textContent = emoji;
        btn.addEventListener('click', () => {
          insertAtCursor(elements.contentInput, emoji);
          elements.contentInput.focus();
        });
        grid.appendChild(btn);
      });
      
      elements.emojiGrid.appendChild(grid);
      
      // Update active category button
      document.querySelectorAll('.emoji-category').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.category === category);
      });
    };

    const insertAtCursor = (input, text) => {
      const start = input.selectionStart;
      const end = input.selectionEnd;
      input.value = input.value.slice(0, start) + text + input.value.slice(end);
      input.setSelectionRange(start + text.length, start + text.length);
      input.dispatchEvent(new Event('input', { bubbles: true }));
    };

    // Attachment handlers
    const handleAttachmentClick = () => elements.attachFile.click();
    const handleAttachmentChange = () => {
      if (elements.attachFile.files.length) {
        elements.attachmentPreview.style.display = 'block';
        elements.attachmentPreview.textContent = 'Selected: ' + elements.attachFile.files[0].name;
      } else {
        elements.attachmentPreview.style.display = 'none';
        elements.attachmentPreview.textContent = '';
      }
    };

    // Typing indicator functionality
    const updateTypingStatus = (isTyping) => {
      fetch(`/conversations/${CONVERSATION_ID}/typing/`, {
        method: 'POST',
        headers: {
          'X-Requested-With': 'XMLHttpRequest',
          'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ is_typing: isTyping })
      });
    };

    const checkTypingUsers = () => {
      fetch(`/conversations/${CONVERSATION_ID}/typing-users/`)
        .then(response => response.json())
        .then(data => {
          if (data.status === 'ok' && data.typing_users.length > 0) {
            const first = data.typing_users[0];
            const typingTextEl = elements.typingIndicator.querySelector('.typing-text');
            if (typingTextEl) typingTextEl.textContent = `${first.username} is typing...`;
            elements.typingIndicator.classList.remove('d-none');
          } else {
            elements.typingIndicator.classList.add('d-none');
            const typingTextEl = elements.typingIndicator.querySelector('.typing-text');
            if (typingTextEl) typingTextEl.textContent = '';
          }
        });
    };

    // Start checking for typing users periodically
    setInterval(checkTypingUsers, 1500);

    // Poll participant online statuses and update dots
    const pollStatuses = () => {
      fetch(`/conversations/${CONVERSATION_ID}/statuses/`)
        .then(r => r.json())
        .then(data => {
          if (data.status !== 'ok') return;
          data.participants.forEach(p => {
            // find any status dot with this data-user-id
            document.querySelectorAll(`span[data-user-id="${p.id}"]`).forEach(span => {
              span.classList.remove('text-success', 'text-warning', 'text-danger');
              if (p.status === 'online') span.classList.add('text-success');
              else if (p.status === 'away') span.classList.add('text-warning');
              else span.classList.add('text-danger');
            });
          });
        });
    };

    // Start polling statuses
    setInterval(pollStatuses, 5000);

    // Block/unblock button handler
    document.querySelectorAll('[id^="block-user-"]').forEach(btn => {
      btn.addEventListener('click', (e) => {
        const id = btn.id.split('-').pop();
        if (!confirm('Block this user? You can unblock later from the conversation.')) return;

        fetch(`/users/${id}/block/`, {
          method: 'POST',
          headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            'Content-Type': 'application/json'
          }
        })
        .then(r => r.json())
        .then(data => {
          if (data.status === 'blocked') {
            btn.textContent = 'Unblock';
            btn.classList.remove('btn-outline-danger');
            btn.classList.add('btn-danger');
          } else if (data.status === 'unblocked') {
            btn.textContent = 'Block';
            btn.classList.remove('btn-danger');
            btn.classList.add('btn-outline-danger');
          }
        });
      });
    });

    // Monitor input for typing status
    elements.contentInput.addEventListener('input', () => {
      clearTimeout(typingTimeout);
      updateTypingStatus(true);
      
      typingTimeout = setTimeout(() => {
        updateTypingStatus(false);
      }, TYPING_TIMEOUT);
    });

    // Form submission
    const handleFormSubmit = (e) => {
      e.preventDefault();
      
      const formData = new FormData(elements.form);
      const content = formData.get('content');
      const attachmentName = elements.attachFile.files.length ? elements.attachFile.files[0].name : '';
      
      if (!content.trim()) return;
      
      // Clear errors
      if (elements.formErrors) elements.formErrors.style.display = 'none';
      if (elements.contentErrors) elements.contentErrors.style.display = 'none';
      
      fetch(window.location.href, {
        method: 'POST',
        headers: {
          'X-Requested-With': 'XMLHttpRequest',
          'X-CSRFToken': formData.get('csrfmiddlewaretoken'),
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          content: content,
          attachment: attachmentName,
          replyTo: replyingTo
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.status === 'ok') {
          const attachmentHtml = data.message.attachment ? 
            `<div class="small text-muted">Attachment: ${data.message.attachment}</div>` : '';
          
          const messageHtml = `
            <div class="d-flex mb-3 justify-content-end align-items-end" data-message-id="${data.message.id}">
              <div class="message-bubble message-mine">
                <div class="message-content">${data.message.content}</div>
                ${attachmentHtml}
                <div class="message-actions mt-1 text-end" style="opacity: 0.8">
                  <button class="btn btn-sm btn-link text-light reply-message" title="Reply" data-content="${data.message.content}">
                    <i class="bi bi-reply"></i>
                  </button>
                  <button class="btn btn-sm btn-link text-light edit-message" title="Edit">
                    <i class="bi bi-pencil"></i>
                  </button>
                  <button class="btn btn-sm btn-link text-light delete-message" title="Delete">
                    <i class="bi bi-trash"></i>
                  </button>
                </div>
                <small class="text-light d-block text-end">${data.message.timestamp}</small>
              </div>
              <div class="ms-2">
                <img src="${data.message.sender_photo || ''}" alt="${data.message.sender}" 
                     class="rounded-circle" style="width:36px;height:36px;object-fit:cover;">
              </div>
            </div>
          `;
          
          elements.messages.insertAdjacentHTML('beforeend', messageHtml);
          elements.form.reset();
          replyingTo = null;
          elements.replyPreview.style.display = 'none';
          elements.messages.scrollTop = elements.messages.scrollHeight;
        } else {
          if (data.errors?.content && elements.contentErrors) {
            elements.contentErrors.innerHTML = data.errors.content.join('<br>');
            elements.contentErrors.style.display = 'block';
          } else if (elements.formErrors) {
            elements.formErrors.innerHTML = 'Error sending message. Please try again.';
            elements.formErrors.style.display = 'block';
          }
        }
      })
      .catch(error => {
        console.error('Error:', error);
        if (elements.formErrors) {
          elements.formErrors.innerHTML = 'Error sending message. Please try again.';
          elements.formErrors.style.display = 'block';
        }
      });
    };

    // Emoji panel toggle
    const handleEmojiButtonClick = () => {
      const isHidden = elements.emojiPanel.style.display === 'none';
      elements.emojiPanel.style.display = isHidden ? 'block' : 'none';
      if (isHidden) {
        showEmojiCategory(currentCategory);
      }
    };

    // Close emoji panel when clicking outside
    const handleOutsideClick = (e) => {
      if (!elements.emojiPanel.contains(e.target) && e.target !== elements.emojiBtn) {
        elements.emojiPanel.style.display = 'none';
      }
    };

    // Add keyboard navigation
    const handleKeydown = (e) => {
      if (e.key === 'Escape') {
        elements.emojiPanel.style.display = 'none';
        if (replyingTo) {
          handleCancelReply();
        }
      }
    };

    // Initialize emoji categories
    document.querySelectorAll('.emoji-category').forEach(btn => {
      btn.addEventListener('click', () => showEmojiCategory(btn.dataset.category));
    });

    // Bind all event listeners
    elements.messages.addEventListener('click', handleMessageEdit);
    elements.messages.addEventListener('click', handleMessageDelete);
    elements.messages.addEventListener('click', handleReplyClick);
    elements.form.addEventListener('submit', handleFormSubmit);
    elements.attachBtn.addEventListener('click', handleAttachmentClick);
    elements.attachFile.addEventListener('change', handleAttachmentChange);
    elements.cancelReply.addEventListener('click', handleCancelReply);
    elements.emojiBtn.addEventListener('click', handleEmojiButtonClick);
    document.addEventListener('click', handleOutsideClick);
    document.addEventListener('keydown', handleKeydown);

    // Initial scroll to bottom
    elements.messages.scrollTop = elements.messages.scrollHeight;
  });
})();
</script>
{% endblock %}